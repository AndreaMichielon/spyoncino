# =============================================================================
# SPYONCINO CONFIGURATION (MANIFEST SIMPLIFIED)
# =============================================================================
# - Sections mirror the modular architecture (cameras, detection, storage, system,
#   dashboards, outputs). Every module derives its config from these blocks.
# - All parameters that operators may tune include inline comments explaining
#   purpose, units, and valid values.
# - Use `@secrets path.to.value` to reference sensitive data from secrets.yaml.
# =============================================================================

# =============================================================================
# CAMERAS
# =============================================================================
cameras:
  - camera_id: "default"        # Logical ID used in bus topics (camera.<id>.frame)
    usb_port: 0                 # USB index or file path; set `rtsp_url` for network cams
    rtsp_url: null              # Example: rtsp://user:pass@host/stream (null disables RTSP)
    width: 960                 # Set to null to keep native width
    height: null                 # Set to null to keep native height
    fps: null                     # Frames per second; null lets the driver decide
    interval_seconds: 1.0       # Capture interval for simulator/throttled inputs

# =============================================================================
# DETECTION (motion, YOLO, dedupe, zoning, media artifacts)
# =============================================================================
detection:
  interval: 2.0                  # Seconds between motion-processing batches
  record_frames: 100              # Frames cached per detection for GIF/clip builders
  confidence: 0.25               # YOLO confidence threshold (0-1)
  model_path: "config/yolov8n.pt"  # Path to Ultralytics model weights
  class_filter: []               # Optional list of class names to keep (empty = all)
  motion_threshold: 5            # Pixel delta threshold for basic motion detector
  label_cooldown_seconds: 10.0   # Prevent duplicate alerts for the same label
  bbox_overlap_threshold: 0.6    # IOU merge threshold for dedupe logic
  alert_labels:
    - "person"                   # YOLO classes that should trigger alert routing

  alert_pipeline:
    input_topic: "process.yolo.detected"    # Source detections to feed into the pipeline
    output_topic: "process.alert.detected"  # Topic for deduped/high-confidence alerts
    target_labels:
      - "person"                 # Labels to treat as “person-level” alerts
    min_confidence: 0.35         # Minimum confidence to forward into the alert topic
    cooldown_seconds: 30.0       # Anti-spam cooldown per camera/label
    bbox_iou_threshold: 0.6      # Merge detections seen as the same object
    timeout_seconds: 5.0         # Wait for detections before declaring silence

  dedupe:
    input_topic: "process.motion.detected"  # Raw detections to deduplicate
    output_topic: "process.motion.unique"   # Topic after dedupe
    window_seconds: 30.0            # Detections inside this window collapse together
    key_fields:
      - "camera_id"                # Fields used to build the dedupe signature
      - "detector_id"
      - "attributes.label"

  zoning:
    enabled: false                 # Enable include/exclude zones on detections
    input_topic: "process.motion.unique"   # Source detections to zone-filter
    output_topic: "process.motion.zoned"   # Topic for detections that pass zone rules
    unmatched_topic: null          # Optional topic for detections outside zones
    # Note: Zone bounds are normalized (0.0-1.0). Frame size is auto-detected from the stream.
    zones:                         # Top-level list; set to null to disable zoning completely
      - camera_id: "default"       # Camera the nested zones apply to
        zones: null                # Null = no zones for this camera (acts as disabled zoning for this camera)
    # - camera_id: "default"       # Camera that owns the zone definitions
    #   zones:
    #     door:                    # Zone identifier (unique per camera)
    #       bounds: [0.0, 0.0, 0.6, 1.0]  # Normalized [x1,y1,x2,y2] covering 0-1 space
    #       labels: ["person"]     # Optional list restricting which labels trigger the zone
    #       action: "include"      # include|exclude; action decides whether detection is kept

  notifications:
    # High‑level switches that control what ends up in Telegram (and which
    # artifact builders are wired by default). These are the ONLY knobs most
    # users need to touch.
    output_for_motion: "gif"        # null/text/snap/gif/video – what to send on motion-only events
    output_for_detection: "video"   # null/text/snap/gif/video – what to send on person/object events

    cooldown_enabled: true         # Enable cooldown filtering to prevent duplicate notifications
    cooldown_seconds: 30.0         # Minimum seconds between notifications per camera/type
    bbox_iou_threshold: 0.6       # IoU threshold for bbox overlap detection (0-1, higher = stricter)
    timeout_seconds: 5.0           # Reset cooldown after this many seconds of inactivity

    snap:
      max_dimension: 640           # Max width or height in pixels (aspect preserved)

    gif:
      max_dimension: 640           # Maximum width or height in pixels (reduces file size significantly)
      fps: 10                      # GIF playback FPS (also used when transcoding to MP4 for Telegram)
      duration_seconds: 3.0          # Seconds captured per GIF
      max_file_size_mb: 50.0       # Upper bound for GIF payload size

    video:
      enabled: true                # Disable to skip clip generation entirely
      max_dimension: 640           # Max width or height in pixels (aspect preserved)
      fps: 12                      # Clip FPS for both on-disk storage and Telegram
      duration_seconds: 5.0        # Seconds captured per clip
      max_file_size_mb: 50.0       # Upper bound for clip payload size
      max_artifacts: 25            # How many clips to retain on disk before pruning

# =============================================================================
# STORAGE
# =============================================================================
storage:
  path: "recordings"               # Root directory for all artifacts/logs
  snap_subdir: "snapshots"         # Relative folder for still images
  gif_subdir: "gifs"               # Relative folder for GIFs
  video_subdir: "clips"            # Relative folder for MP4 clips
  retention_hours: 24              # Standard cleanup horizon
  aggressive_cleanup_hours: 12     # Used when disk space drops below threshold
  low_space_threshold_gb: 1.0      # Trigger aggressive cleanup below this free space
  s3:
    enabled: false                 # Enable to mirror artifacts to S3-compatible storage
    bucket: null                   # Destination bucket name
    region_name: null              # AWS region (if using AWS)
    prefix: ""                     # Optional key prefix per artifact
    publish_topic: "storage.s3.synced"      # Topic for successful uploads
    discrepancy_topic: "storage.discrepancy"  # Topic for drift reports

# =============================================================================
# SYSTEM (logging, bot defaults, control surfaces, resilience)
# =============================================================================
system:
  monitoring:
    check_interval: 5.0            # Seconds between orchestrator self-checks
  logging:
    log_level: "INFO"              # Root logging level
    log_format: "%(asctime)s [%(levelname)8s] %(name)s: %(message)s"  # Log line format
    log_max_size_mb: 10            # Rotating file max size (MB)
    log_backup_count: 3            # Number of rotated log files to keep
  advanced:
    analytics_figure_width: 22     # Legacy chart width (inches)
    analytics_figure_height: 5.5   # Legacy chart height (inches)
    analytics_intervals:           # Minute-based histogram buckets for analytics
      - 5
      - 15
      - 60
      - 120
  security:
    notification_chat_id: null     # Force notifications into a specific chat ID
    allow_group_commands: true     # Permit bot commands from groups
    silent_unauthorized: true      # Drop responses when user isn’t authorized
  rate_limiting:
    notification_rate_limit: 5     # Notifications per minute (global)
    command_rate_limit: 10         # Bot commands per minute per user
    failed_auth_lockout: 300       # Seconds to lock users after auth failures
  behavior:
    send_typing_action: true       # Show Telegram “typing…” while processing commands
    delete_old_menus: true         # Auto-clean inline keyboards
    command_timeout: 30            # Seconds to wait for command completion
    snapshot_timeout: 10           # Seconds to wait for /snapshot replies
    enable_analytics: true         # Whether bot exposes analytics commands
    enable_recordings_browser: true  # Allow browsing recordings via bot
  resilience:
    enabled: false                 # Enable to allow chaos scenarios via control surface
    scenarios: []                  # Define latency/drop injections here
  control_api: &control_api_defaults
    host: "0.0.0.0"                # FastAPI bind address
    port: 8080
    serve_api: true
    command_topic: "dashboard.control.command"  # Topic for orchestrator commands
    config_topic: "config.update"               # Hot-reload topic
    tls:
      enabled: false               # Enable HTTPS (requires cert + key files below)
      certfile: "config/certs/control-api.crt"
      keyfile: "config/certs/control-api.key"
      ca_certfile: null            # Optional CA bundle for mutual TLS
      require_client_cert: false   # Set true to require client certificates

# =============================================================================
# DASHBOARDS (manifests + streaming settings)
# =============================================================================
dashboards:
  websocket_gateway:
    host: "0.0.0.0"                # Websocket gateway bind address (0.0.0.0 = all interfaces)
    port: 8765                     # Websocket port exposed to clients
    serve_http: true               # Toggle HTTP long-poll fallback
    tls:
      enabled: false               # Enable WSS (requires cert + key files below)
      certfile: "config/certs/websocket.crt"
      keyfile: "config/certs/websocket.key"
      ca_certfile: null
      require_client_cert: false
    topics:
      - "status.health.summary"    # Which topics should be streamed to clients
      - "status.bus"
      - "analytics.persistence.cursor"
      - "storage.stats"
    buffer_size: 256               # Max buffered events per connection
    idle_timeout_seconds: 30       # Close connection if idle for this many seconds
  modules:
    - module: modules.dashboard.control_api      # Run the FastAPI control plane
      additive: true
    - module: modules.dashboard.websocket_gateway  # Run the websocket streaming module
      additive: true
    - module: modules.dashboard.telegram_bot       # Run the Telegram control bot
      additive: true

# =============================================================================
# OUTPUTS (rate limiter + notifier manifests)
# =============================================================================
outputs:
  rate_limit:
    input_topic: "event.snapshot.ready"   # Topic whose events should be throttled
    output_topic: "event.snapshot.allowed"  # Topic to publish when events pass throttle
    max_events: 5                          # Allowed events per window
    per_seconds: 60                        # Window size (seconds)
    key_field: "camera_id"                 # Apply throttle separately per this field
  modules:
    - module: modules.output.telegram_notifier   # Telegram notifier
      additive: true
    - module: modules.output.email_notifier      # Email notifier (disabled by default)
      enabled: false
      additive: true
    - module: modules.output.webhook_notifier    # Webhook notifier (disabled by default)
      enabled: false
      additive: true
      options:
        require_https: true        # Enforce https:// URLs unless explicitly disabled
